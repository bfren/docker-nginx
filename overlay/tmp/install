#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bf-adduser www


#======================================================================================================================
# Install prerequisites.
#======================================================================================================================

apt update && apt install --no-install-recommends --no-install-suggests -y \
    curl \
    gnupg2 \
    ca-certificates \
    lsb-release \
    debian-archive-keyring


#======================================================================================================================
# Add Nginx signing key and verify signature.
#======================================================================================================================

KEYRING=/usr/share/keyrings/nginx-archive-keyring.gpg
curl https://nginx.org/keys/nginx_signing.key | gpg --dearmor \
    | tee ${KEYRING} >/dev/null

EXPECTED_SIG="573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62"
ACTUAL_SIG=`gpg --dry-run --quiet --no-keyring --import --import-options import-show ${KEYRING} | grep ${EXPECTED_SIG}`

if [ "${EXPECTED_SIG}" -ne "${ACTUAL_SIG}" ] ; then
    bf-error "Nginx keyring signature is incorrect."
fi


#======================================================================================================================
# Add and pin official Nginx repository.
#======================================================================================================================

cd /tmp

REPO=$(cat NGINX_REPO)
echo "deb [signed-by=${KEYRING}] ${REPO} `lsb_release -cs` nginx" \
    | tee /etc/apt/sources.list.d/nginx.list

echo -e "Package: *\nPin: origin nginx.org\nPin: release o=nginx\nPin-Priority: 900\n" \
    | tee /etc/apt/preferences.d/99nginx


#======================================================================================================================
# Get Nginx Version.
#======================================================================================================================

VERSION=$(cat NGINX_REVISION)
bf-echo "Nginx version ${VERSION}."


#======================================================================================================================
# Install Nginx and dependencies.
#======================================================================================================================

bf-echo "Installing Nginx v${VERSION}..."
apt update && apt install --no-install-recommends --no-install-suggests -y \
    nginx=${VERSION}*
bf-done


#======================================================================================================================
# Cleanup.
#======================================================================================================================

CONF_D=/etc/nginx/conf.d
HTTP_D=/etc/nginx/http.d
bf-echo "Cleaning up default Nginx configuration and files."
rm -rf ${CONF_D} ${HTTP_D} /var/www/*


#======================================================================================================================
# Create and link Nginx directories.
#======================================================================================================================

bf-echo "Creating Nginx directories."

mkdir -p /var/lib/nginx
mkdir -p /run/nginx

mkdir -p ${HTTP_D}
ln -s ${HTTP_D} ${CONF_D} # older builds of Nginx use conf.d instead of http.d

bf-echo "Linking /www to /var/www/localhost."
ln -s /www /var/www/localhost
